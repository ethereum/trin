use alloy::{eips::eip7685::Requests as AlloyRequests, primitives::B256};
use serde::{Deserialize, Serialize};
use ssz::Encode;
use ssz_derive::{Decode, Encode};
use ssz_types::{
    typenum::{U16, U2, U8192},
    VariableList,
};
use tree_hash_derive::TreeHash;

use crate::consensus::{
    consolidation_request::ConsolidationRequest, deposit_request::DepositRequest,
    withdrawal_request::WithdrawalRequest,
};

type MaxDepositRequestsPerPayload = U8192;
type MaxWithdrawalRequestsPerPayload = U16;
type MaxConsolidationRequestsPerPayload = U2;

pub type DepositRequests = VariableList<DepositRequest, MaxDepositRequestsPerPayload>;
pub type WithdrawalRequests = VariableList<WithdrawalRequest, MaxWithdrawalRequestsPerPayload>;
pub type ConsolidationRequests =
    VariableList<ConsolidationRequest, MaxConsolidationRequestsPerPayload>;

#[derive(Debug, Default, Clone, Serialize, Deserialize, Encode, Decode, TreeHash, PartialEq)]
pub struct ExecutionRequests {
    pub deposits: DepositRequests,
    pub withdrawals: WithdrawalRequests,
    pub consolidations: ConsolidationRequests,
}

impl ExecutionRequests {
    pub fn requests_hash(&self) -> B256 {
        let mut requests = AlloyRequests::with_capacity(3);

        requests.push_request_with_type(DepositRequest::REQUEST_TYPE, self.deposits.as_ssz_bytes());
        requests.push_request_with_type(
            WithdrawalRequest::REQUEST_TYPE,
            self.withdrawals.as_ssz_bytes(),
        );
        requests.push_request_with_type(
            ConsolidationRequest::REQUEST_TYPE,
            self.consolidations.as_ssz_bytes(),
        );

        requests.requests_hash()
    }
}

#[cfg(test)]
mod tests {
    use alloy::primitives::b256;
    use ssz::Decode;

    use super::*;

    #[test]
    fn test_requests_hash() {
        // The ExecutionRequests from https://etherscan.io/block/22438180
        let execution_requests = ExecutionRequests::from_ssz_bytes(&hex::decode("0c0000000c1800000c1800009941bbe4d28053f234b3a63dcdfcccd19434d14dc4fc054fbd015b49ff85c6a98ca2524254369fdfc8e3ae6bc026bf16010000000000000000000000a554965fcd0d9493313e2eafa27eef5b058336f40040597307000000a24f7e3b88da0e35aa541af47b1b1e0235c1ae32552fd31f6414bc066dcdf9bbdf5db86712e483c8f3df6b768874ce4703937440fb09852121cc9b6877bd2272328ee7928a01906a4ca039b0667d8cae71215b88b2a329d6a0860165778f240b0a371f00000000009028e3c384e3400db68b0914d3bb476cdbe161ab70fa78b1c805d2bc8318e6d7a78fcb1b3a41e67461aa57c0579dcd69010000000000000000000000a554965fcd0d9493313e2eafa27eef5b058336f40040597307000000a4723e304d335a17b3de477d85543b1b248f0d7524d00f36d2e733ceb481445d1bf4457873d29f387b6bc7701a486f1d031b2b18884fefa778c6d119c781484f5877a3a7b0a33637ffc8f9a1bda69ab9500515d75a664cb87001d055691d8bb20b371f0000000000a13799641012eda0650c28021fb4491cb6b3a9fac08116cc95683f163d87b1db2cf8fdd78b1a99344a43f3ee12100cdd010000000000000000000000a554965fcd0d9493313e2eafa27eef5b058336f40040597307000000b5f8a8f2259f0819d69f111b2b93ca2cd23967f3f62559ed3285e8cdbae796d915771a00e8e005fe32c0a88518f8b72b134b3096071e0cd138bc7f84f9ad538f75d65dba3ea7f614363ab172f585b927f0f7bf49a7c5064f0c7b3f8985b6ce3a0c371f00000000008dd5bfb35705aa5e469cd2f45fef415123014d0266da43f36c81741b54509e3ae994911f306f71239123b116a0264e84010000000000000000000000a554965fcd0d9493313e2eafa27eef5b058336f400405973070000009986ebc44dd9b18ef0a9e4e539c20eac68ea8f396010d9087ac8707a2b73b5a4bfd697627a842d0ba61ec1ddadf11b8419b0178f8adb8dd29b20814660a3cff7ed049a1a614b5d6bae1e14eac848ebadddf902e7e2e0a78a352d7b7546d3c4060d371f0000000000a54cb37dda3ffcf4cd6993b1ef0bd6038638008c57275921dbc80f232a6013cdf82a353f36611c7f64e392e56341b19d010000000000000000000000a554965fcd0d9493313e2eafa27eef5b058336f40040597307000000b2a77e1f4cb4b096a081bb678a8312c060dafda882c4e1cdb09270948a30b2b15277c112fa8dda7a4875ce98dc092537109cf04fc27344b1b39bd6e199bcefb871343cdbb6629fe48737b452ad0fe2f230badf4bd7305f424c83472845862e230e371f0000000000944cdc319c7a5a53d6de2b36ed20799b83a1030f0fa54797346bb45009b4286b1034a31f515c7aa9bd12213286aa68f8010000000000000000000000a554965fcd0d9493313e2eafa27eef5b058336f40040597307000000b856982bda086b4467c5ccbd89c1995deec497b09d9db8b4f78fe9b8a1cf112e55207906ba45645ede584fdb2242c48c10ce2acb41ba7dc24ede2fef11d2eb1c32c226c276023df588933aa5c0236c2dce6e2e17a1dc8aa21ec71f96f1e8775c0f371f0000000000b1d631f2fdaf6afcc84caeb0fd6d6901e9f5dcaa9b1918c2e7e114aa3c19172991fda1729d9dfc095fcdeccaf7b4ece3010000000000000000000000a554965fcd0d9493313e2eafa27eef5b058336f40040597307000000abe30472d94074933014bd55df1604962163e7fb5b77239d146945587b53baca46f73cfdaa7bc91f65dd81bb65ddb0ab0b614dfda7834ff058b072dc362faca14ca5f6c02df92533812218e55ea99886081637e9bd59b4ab833e24cd53746b1810371f0000000000a3937cc43cbbb148e3f8256e7554068088cd3ce0d166842f02c46a52d924bd09a93940163e12e89f3a8003613adbd78b010000000000000000000000a554965fcd0d9493313e2eafa27eef5b058336f400405973070000008ce94979ec76d4f5a9786799550e63d950add26a2f54eacf3be38a2974d5ce19c3a3fa71a121d56a5e6eaf99fa20268e0f232514987ef505cc8e3dbf3b48d7738cfd91319e44bd5f18ae12e1bc3c7642662680b27c13a7efca2a4afc0b41bf0511371f000000000099e057498edc0b8b5b0f0bea56e96e2d578c4685ea8cf48fa73d6409d670bf9c48e12c55aea8abf9eef1a7c7846aca86010000000000000000000000a554965fcd0d9493313e2eafa27eef5b058336f400405973070000008f0364ac2ea823762649475a56757b230e6cee40b84496b88ff2615c5fa445349bce1d16f3db2f415b3bc76a5a97fda906d366f7523d3f3e456476f8d7f52c60c199798c8273fe9ec22b68988d8c34f2e6eb7ba3473b586f4a5a46e03962c9e012371f0000000000919fa5026549cb85cf2cd8cf8d2ddb3637fa9ced411d366cd99fe27d2ca6d0ce68952f52a78b4eb472319e089ea1d5ca010000000000000000000000a554965fcd0d9493313e2eafa27eef5b058336f40040597307000000a9e3ee9ac4890f9d1282056d1c9fe294509e009d9690bbe2bfaa01f5515fbd430efd90d4a524338e4cc0f81e5daf2b670a4a6c1f7fdb62f68f9ffc5dcde6df1dd5d8f507d8be21b441dd2f64dec159a762608edf564bc855c85b81b268a1086013371f00000000008bfd0a4e27212c98579a7dfc45d39695310de33c7b9d70ba0faf49e7db9a7ba9fe3c8d1543dd2d2ab271cabdb2015c06010000000000000000000000a554965fcd0d9493313e2eafa27eef5b058336f40040597307000000a0df826394c7b87e977b9ab512a651b593f741942b435dc2e0b897c8414d3a918afabbf54a47687128ff8ea4e9d45a4c0d0c971acfa303df2df2b88dc3699ff2b7cee6aaa2a48d1824531433265b0bd701304b14c08e4824be7cf4bb81ea4e0a14371f000000000087c1466dffcccb0ea83163ec33326923198a2c32c4721dea1c3042770adab9029be18baf42e1734f71ae979dd11f3bf7010000000000000000000000a554965fcd0d9493313e2eafa27eef5b058336f40040597307000000b43cf82f90282899b992547b39a27efb5c657cb47845088d925f49fa396b0a6004b8c43d5e765f9187369b94a1895f5b14b9306599be588b28800bb2c2a259cf0322330ab69fd187a63f84431e111af62975152d934f6c3dbefd225c92a4794815371f0000000000990c0e9f9652023b72f48b1ce1a0c0e67e57c33efd9fed58c50dd8e8a9167051d6e782a3daf8890c75cfbbbba2bca045010000000000000000000000a554965fcd0d9493313e2eafa27eef5b058336f4004059730700000099d5f4890972e518a62d0b5fea04e163e548337dcc0d54e57651b11453af6a298c993cf54befcb789629c5faae3bf9dd19ab397594bdbe031686fe7f64ce4eb2969bd47fba7c9779e6ff2f56cac7ab754c2a56a5b3b472e2acdd3a401ef87c0b16371f0000000000a739fac4126cfa52d1013bc50084c071d6924ad926a1eed5da70e3025903f3291f7584677e4d07f6552c5b79a7e463ba010000000000000000000000a554965fcd0d9493313e2eafa27eef5b058336f40040597307000000809fb53a7b8db12bae24a87ea728ce53194d03b449291b59983ff4e350ba7e7b00c019f049cc87adb1b1df1f32726f48182b0c11c8a9648bc49bf6e8a60d4b2872f4e5dd8d017655b337bf21d426bc06764353211ee3d0d7711d734a11c62ef217371f0000000000b943c363784cc03d0dd7eb865848ed5b852d4360c4e1a62aeac3cbadd3e506d5d7716d386ab46055b435a3bd1ac8325c010000000000000000000000a554965fcd0d9493313e2eafa27eef5b058336f40040597307000000b45d6aba595d930306b9c10baa7881cb1e6874d4d8edc0a61e568a0b96d57d2972b8ab6abf47c1d7da14416acc5de6a0132db0d47c4073761513067b41f1d15e24a56bc16f608b50ff5446e20328a5df8b19fb8a122cc773a2b6f0b79b6965bb18371f0000000000a284edd657cc98eb61e33ab3707a25ecd97635a291a05aace69201873d42db900b552440c6434e9a159e81f85d71c526010000000000000000000000a554965fcd0d9493313e2eafa27eef5b058336f4004059730700000087ad6227ece9401d514ac7d1d247e08440bd6724e970423d96994d6b9e9926eae44238628308490464fa2afcb40e3094030a98f9ed33834a67080489d0ccb8d5426c1a35b613bff17a8e59c762f32e5cdb13c6729123a0b89d9df8418d13c59b19371f00000000008524861a9fb443f2dc6d443f61869ed1c84a0e373650d36565d38ba30db33a9485bdfa8dbf8b8589339a6c5ecf79e6cb010000000000000000000000a554965fcd0d9493313e2eafa27eef5b058336f4004059730700000091f94e1cd0afaf7ebcc2941a6effb3d4e4fd8ae5a5800cf777f0302476ec374eedec5709d0f8737425d8033e1804d09603651a8dffc87bf812c65ddb7f27a6559ea3b21aefb5b8a380b4f9c7e8882127c7dc2961fbbc484515ec7ac9899f129b1a371f000000000092f92d430aed308e8e421c4fec20e315004ee49ccf377c4aa45d1dcb56c65b15d0beacbc00b83323336492a60ad92a3a010000000000000000000000a554965fcd0d9493313e2eafa27eef5b058336f40040597307000000913dfe926fc427499d4bb3071cf893e8802c5d48344bc45f0c5a2ca34cef1a07028209a9ce6f6ea7ab3c3fc3419c73ff07f75f1f74bb392df36b548e0610307a6070d8b02197122dbee5b1689f20e8ab1fb7840b92b8f2d9eb211bdb13bfa46a1b371f0000000000a0a654f2ba6f3fe2486b311c73cf9b766e9e72c6dea5e3963377873df4a67813ec733aaa8a9d562b5c0cb59dd447fb97010000000000000000000000a554965fcd0d9493313e2eafa27eef5b058336f400405973070000009361a8d14529a3dbae45e73ca6aa0c8e63bda6387bc37c7bcb00dff9690dbd7117cea95c101babac6c1077f28c79df4a19faa2008ed7efe4ce79364660815f192bfc7c3818e8570a0881c7b308effb676d65214aa56bc8bf2e2b9a7ce179d66f1c371f0000000000a8bf91057ed8aaf29d7b10dc5cf3d99ac04ba723e6ba2e9fd5bcdda6f284a577647f628696c6f017d2c950ea88def997010000000000000000000000a554965fcd0d9493313e2eafa27eef5b058336f40040597307000000b1a7e1cf2de7edc640314117f8f6d2326998d708455a9cc971b1f94354182f6ee75859a7fa667cde7f7d0371ca2bc7cc071cf34a467a4e3aca41ba89a7f7cd11d796ec169bd2862a4fed16ec39d15cb1921074520bac43ce8549f10f9a8260331d371f00000000008f757f7a4e95347922c01a47c08ad95d0da7e3006f81d1faa2ec1f0b5b086b82a4e44de7fe249c392c715e1b938259da010000000000000000000000a554965fcd0d9493313e2eafa27eef5b058336f4004059730700000096f89f5e6325e07af09f90328090a4d6fad1356a66be6192b347c67ea208173011548a534fc6faa05d5514ad546dc240195020709b153388acbe6f5200dc0c9e4daa7a0cd886dc9db3fbb229a8e793c78b8c909f7a41040e3a80dc730fee1e001e371f000000000080599e71db2dba916111b81a71a77e7d2c099e7c49086a8262bec88b47c36cfd057cffbcab8a93f1a368ea255d96a037010000000000000000000000a554965fcd0d9493313e2eafa27eef5b058336f4004059730700000096f59289321974ea71763e895c06dc5c2a880869301cb13af72caee0649e85071d5aaf633954a9be9bcff84c19fc169d00237cbf97b939c8ac9bdaa8677bc09dd43129ade0428a9a6b057ec86fbd8bb1baec25842a8f579e43874ec9e3f2f6061f371f0000000000b6fafa095f91399c0693fe60dbacfde186ac1b5291896a1874d75b9cbfbc44ca036f0224b8197b65979f6e433848222a010000000000000000000000a554965fcd0d9493313e2eafa27eef5b058336f40040597307000000a1b93cd592cc50aa3eb6c31e13925f6c3626ba71e0efcb6fcbaae1e0b95073d136ee3c320c7abc7c6bc72823b956ecf706401dbcbbc87c313eef8988a091522ab9a49e6a1e7bac096f94f7266402a1bf07a2f970d0544f3d732d9591b4eadc7220371f000000000093c032911eb220e21d56aea97289f9c9196aaa4cac13f90d51dd4e864dce8a82e19e74fdb7d2150a05839f3836932286010000000000000000000000a554965fcd0d9493313e2eafa27eef5b058336f40040597307000000b9bc8ef0564449b935f576132206f257841d739ba5ddffde02d255f087510a39eab54fdde971dbb965ae0d66fb18de9012e34fc36225aa07464ead62a0fad8f766fe50d9d7a8c727deb4f62168eb5bd747ecbbbb4647bdcf5a98a26a997a07fc21371f00000000009657dc9bffe5ff5b5b68443befea9aef8da5c5cb38b7c7b4765913805ed6b5a9c48017d3477ad975b7ddbea9740696dc010000000000000000000000a554965fcd0d9493313e2eafa27eef5b058336f400405973070000008310c3e1ebba7c5de339170050376c5b1924d61ab3a60e088defd375d970d0bb414271dbf9460b556b3caecc1c8a86a117b633cfa07c508996bbc3b700320607c2379c65cfe6e9ad990b5241580b36353bd47b09c6417da2e1aa89a57b4888df22371f0000000000a364ff83af69e764be811dc97eaac06afc32d42f23c966428b2cdd203c6928cd785a1e134455a668e82b09a75bd8fb7c010000000000000000000000a554965fcd0d9493313e2eafa27eef5b058336f40040597307000000a55c50ee8d2c434cfdec1431d0c720d9b128423cd2946a42e8337758eae84fa26c0a9f4717898ea593c483eafecd442504f880549f988ac9272bbc82215c3941db2512bb688107ce9b29731771595f782b562df305fdb7961cd691cca9a87e6623371f0000000000b759910491e291834d1be5ea1c644e6170f5d3024fb8701ace342ce5f20e393e7b4b10a98890040445928d736bf7b61f010000000000000000000000a554965fcd0d9493313e2eafa27eef5b058336f40040597307000000ab3d3e6e0a8623b163dea6e4f8c905f4be4b341b67171b1797e223d59110a7c5c6dbaabbeec36a000f9dcbfd98caa04207f0b78e8cc8bfb5f5dde1cf5feed96dac92860006b6cff0d0fd4a56ba4620a3dd76a39d7315f08c022f4d033aa3fe4c24371f000000000097ea5e991705ed5226fbb6383c8f2528ac5ff9d3a1f1d16ff25be9ef40c2cbe053ee544fcbd96a065051a2f23ae1fc0b010000000000000000000000a554965fcd0d9493313e2eafa27eef5b058336f40040597307000000a3d154a33e924e66f57acb112aa12e48f05c0d965fa64adffec56c1ef324aba24775b5d3949dacba49b33e110581f4280b62a8064d3b3230f5c1a2073b29759453bf7833e91facd8e5cc5d390fd365d29154430a39d52f59d51b1692f811ca5325371f0000000000a7eb6e148cca958233645533c1685a51d04f9217eb1309dd91be76ef5d5967537524bce9a662f0fcd56e49cbadc6782a010000000000000000000000a554965fcd0d9493313e2eafa27eef5b058336f4004059730700000093eae8fe48dac478e5604f37b39b4c793469c7f27d6b667d5ef2bd1a20fb274c7b1ec74618f542c1fc46d23dd058d4490ef5637c0df446fd1ee612ba825f1e53f272959fb50acaf0520bf1ebfc2422a5e55d52af5ee3dfdc8f800931e46a492026371f0000000000b494f6284cc1d7a28690361670ce6ed2443831af7e8bbe3d70ea93df64f1c3836b7281a4ba87ab35c35d04e0918a14b2010000000000000000000000a554965fcd0d9493313e2eafa27eef5b058336f4004059730700000099130cf9a490bebc566cea65f45fdae720885a6cdb21c92067f2d917bf671f2abae68f52652e75a1d867948801da87e70bb533372781b480dd05f0f555dfb49ca05fc606479284a50d835981304a7330f6170b739a2893b4bc057a9b134ab5cd27371f000000000083850dbf765beb92a01c6b302f7cd0c83298bdc1f6a1265b4d2d3a1125163a26caf271b84210505238046adf709e0970010000000000000000000000a554965fcd0d9493313e2eafa27eef5b058336f4004059730700000080d7d679629d82af5ecfd1683a9ff0e5c647608a52f5e711fa929f3f5b4289bf8fe00b5f949bf23878431150c118118519b5114c0b09ef882f6c2d180483e019cc0db5570506d12e4fd6c33ecdafd571fc3202d77f422d29162052ef7e08610028371f0000000000af553643c118d04328cb661856fa685fd4923d48a98d1bc11bce92f0067047c146030c48c22b604d56ef4f43f995ecf4010000000000000000000000a554965fcd0d9493313e2eafa27eef5b058336f400405973070000009657ef12abc81fcb03486292a8dfb8b3332480f74294ce742d7294e0d5c532c140544260a3966a480ebfd58b0ac97878085d50c639f8885e4987960f0a629fdd0a7ee9030212a15981af8a301fe0c7e236b8932ea89fcc42b7c9096707fd75b729371f0000000000").unwrap()).unwrap();

        let expected_hash =
            b256!("0x0f4ca2f2dddfcd4165671b9410ed00bccdf75ee3ae527782348efebd2a26751e");
        assert_eq!(expected_hash, execution_requests.requests_hash());
    }
}
